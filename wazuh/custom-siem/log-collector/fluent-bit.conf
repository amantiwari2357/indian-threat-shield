[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port   2020

[INPUT]
    Name              tail
    Tag               system.logs
    Path              /host/var/log/syslog,/host/var/log/messages,/host/var/log/auth.log
    Parser            syslog
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               application.logs
    Path              /host/var/log/nginx/access.log,/host/var/log/nginx/error.log
    Parser            nginx
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               security.logs
    Path              /host/var/log/auth.log,/host/var/log/secure
    Parser            syslog
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               docker.logs
    Path              /host/var/lib/docker/containers/*/*.log
    Parser            docker
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              systemd
    Tag               systemd.logs
    Systemd_Filter    _SYSTEMD_UNIT=ssh.service
    Systemd_Filter    _SYSTEMD_UNIT=nginx.service
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Read_From_Tail    On

[FILTER]
    Name                modify
    Match               *
    Add                 hostname ${HOSTNAME}
    Add                 agent_id custom-siem-agent
    Add                 timestamp ${time}

[FILTER]
    Name                lua
    Match               *
    Script              /fluent-bit/scripts/add_metadata.lua
    Call                add_metadata

[FILTER]
    Name                record_modifier
    Match               *
    Record              source_type log_collector
    Record              environment production

[OUTPUT]
    Name                kafka
    Match               *
    Brokers             kafka:9092
    Topic               custom-siem-logs
    Message_Key         ${hostname}
    Timestamp_Key       @timestamp
    Message_Headers     Key1 Value1
    Message_Headers     Key2 Value2
    Retry_Limit         False
    Compression         gzip

[OUTPUT]
    Name                elasticsearch
    Match               *
    Host                elasticsearch
    Port                9200
    Index               custom-siem-logs
    Type                _doc
    Logstash_Format     On
    Logstash_Prefix     custom-siem
    Logstash_DateFormat %Y.%m.%d
    Time_Key            @timestamp
    Generate_ID         On
    Suppress_Type_Name  On
    Retry_Limit         False
    HTTP_User           elastic
    HTTP_Passwd         changeme
    tls                 Off
    tls.verify          Off
    tls.debug           0
    tls.ca_file         /fluent-bit/etc/certs/ca.pem
    tls.crt_file        /fluent-bit/etc/certs/cert.pem
    tls.key_file        /fluent-bit/etc/certs/key.pem
    tls.vhost           elasticsearch

[OUTPUT]
    Name                http
    Match               *
    Host                backend-api
    Port                8080
    URI                 /api/v1/logs
    Method              POST
    Header              Content-Type application/json
    Header              Authorization Bearer ${JWT_TOKEN}
    Format              json
    Json_Date_Key       @timestamp
    Json_Date_Format    iso8601
    Retry_Limit         False
    HTTP_User           customsiem
    HTTP_Passwd         customsiem_password
    tls                 Off
    tls.verify          Off
    tls.debug           0
    tls.ca_file         /fluent-bit/etc/certs/ca.pem
    tls.crt_file        /fluent-bit/etc/certs/cert.pem
    tls.key_file        /fluent-bit/etc/certs/key.pem 